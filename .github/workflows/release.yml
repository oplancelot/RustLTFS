name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Build Release Binary
        run: cargo build --release --verbose
      
      - name: Prepare artifacts
        run: |
          mkdir -p release-artifacts
          cp target/release/rustltfs.exe release-artifacts/
          cp README.md release-artifacts/
          cp LICENSE.md release-artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-artifacts/rustltfs.exe
            release-artifacts/README.md
            release-artifacts/LICENSE.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          body: |
            ## RustLTFS ${{ github.ref_name }}
            
            ### 下载
            下载 `rustltfs.exe` 并放到系统PATH中即可使用。
            
            ### 快速开始
            ```bash
            # 查看版本
            rustltfs --version
            
            # 写入文件夹到磁带
            rustltfs write C:\backup --output /tape/backup --tape \\.\TAPE0
            
            # 读取磁带索引
            rustltfs read --tape \\.\TAPE0
            
            # 查看磁带容量
            rustltfs space --tape \\.\TAPE0
            ```
            
            ### 变更日志
            详细变更请查看 [Commits](${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.ref_name }})
            
            ### 文档
            完整文档请参考 [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
